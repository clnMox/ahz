<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Censys URL Constructor</title>
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css" />
  <style>
    body {
      font-family: "Arial", sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #000;
      color: #fff;
    }

    h1 {
      color: #ca6f1e;
    }

    label {
      margin-bottom: 4px;
      display: block;
    }

    input, button, textarea, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 16px;
    }

    button {
      background-color: #4caf50;
      color: #fff;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    textarea {
      resize: none;
    }
  </style>
</head>
<body>
  <h1>Censys URL Constructor</h1>

  <label>IP Entry Mode:</label>
  <label><input type="radio" name="ipEntryMode" value="auto" checked onchange="toggleIPInputMode()" /> Auto (via subnet)</label>
  <label><input type="radio" name="ipEntryMode" value="manual" onchange="toggleIPInputMode()" /> Manual (start/end)</label>

  <input type="hidden" id="urlModeValue" value="subnet" />

  <!-- Auto IP Inputs -->
  <div id="autoIPInputs">
    <div class="flex flex-wrap items-center">
      <div class="w-15 pr3">
        <label for="ipAddress">IP Address:</label>
        <input type="text" id="ipAddress" class="w-100" placeholder="Enter IP address" list="ipHistoryList" oninput="saveToHistory('ipHistory', this.value)" />
        <datalist id="ipHistoryList"></datalist>
      </div>
      <div class="w-5">
        <label for="subnet">Subnet:</label>
        <input type="number" id="subnet" class="w-40" placeholder="Enter subnet" />
      </div>
    </div>
    <button onclick="incrementIPAddress()">Increment IP</button>
  </div>

  <!-- Manual IP Inputs -->
  <div id="manualIPInputs" style="display: none;">
    <div class="flex flex-wrap items-center">
      <div class="w-50 pr3">
        <label for="manualStartIP">Start IP:</label>
        <input type="text" id="manualStartIP" class="w-100" placeholder="e.g. 3.3.3.0" list="manualStartList" oninput="saveToHistory('manualStartHistory', this.value)" />
        <datalist id="manualStartList"></datalist>
      </div>
      <div class="w-50">
        <label for="manualEndIP">End IP:</label>
        <input type="text" id="manualEndIP" class="w-100" placeholder="e.g. 3.3.3.255" list="manualEndList" oninput="saveToHistory('manualEndHistory', this.value)" />
        <datalist id="manualEndList"></datalist>
      </div>
    </div>
  </div>

  <!-- ASN, VHOST, FIELD -->
  <div class="flex flex-wrap items-left">
    <div class="w-33 pr3">
      <label for="asn">ASN:</label>
      <select id="asn" class="w-50">
        <option value="16509">16509</option>
        <option value="209242">209242</option>
        <option value="13335">13335</option>
      </select>
    </div>
    <div class="w-33 pr3">
      <label for="vhost">Virtual Hosts:</label>
      <select id="vhost" class="w-50">
        <option value="ONLY">ONLY</option>
        <option value="EXCLUDE">EXCLUDE</option>
        <option value="INCLUDE" selected>INCLUDE</option>
      </select>
    </div>
    <div class="w-33">
      <label for="field">Field:</label>
      <select id="field" class="w-50">
        <option value="ip">ip</option>
        <option value="name" selected>name</option>
      </select>
    </div>
  </div>

  <label for="date">Date:</label>
  <input type="date" id="date" class="w-100" />

  <button onclick="calculateIPRange()">Calculate</button>

  <div id="result"></div>

  <label for="url">Constructed URL:</label>
  <textarea id="url" rows="4" class="w-100" readonly></textarea>

  <button onclick="openURL()">Open URL</button>

  <script>
    let openedTab;

    function toggleIPInputMode() {
      const mode = document.querySelector('input[name="ipEntryMode"]:checked').value;
      const manualDiv = document.getElementById("manualIPInputs");
      const autoDiv = document.getElementById("autoIPInputs");
      document.getElementById("urlModeValue").value = mode === "manual" ? "range" : "subnet";
      manualDiv.style.display = mode === "manual" ? "block" : "none";
      autoDiv.style.display = mode === "manual" ? "none" : "block";
    }

    function calculateIPRange() {
      const ipEntryMode = document.querySelector('input[name="ipEntryMode"]:checked').value;
      const urlMode = document.getElementById("urlModeValue").value;
      const asn = document.getElementById("asn").value;
      const vhost = document.getElementById("vhost").value;
      const field = document.getElementById("field").value;
      const rawDate = document.getElementById("date").value;

      let formattedDate = "";
      if (rawDate) {
        const dateObj = new Date(rawDate);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const month = monthNames[dateObj.getMonth()];
        const year = dateObj.getFullYear();
        formattedDate = `${day}+${month}+${year}`;
      }

      let result = { start: "", end: "" };

      if (ipEntryMode === "manual") {
        result.start = document.getElementById("manualStartIP").value;
        result.end = document.getElementById("manualEndIP").value;
      } else {
        const ipAddress = document.getElementById("ipAddress").value;
        const subnet = parseInt(document.getElementById("subnet").value);
        result = calculateIPRangeFunction(ipAddress, subnet);
      }

      document.getElementById("result").innerHTML =
        `Start IP: ${result.start}<br>End IP: ${result.end}`;

      let url = "";

      if (urlMode === "subnet") {
        const subnet = parseInt(document.getElementById("subnet").value);
        url = `https://search.censys.io/search/report?resource=hosts&q=%28%28services.http.response.headers%3A+%28key%3A%60Last-Modified%60+and+value.headers%3A%60${formattedDate}%60%29+and+autonomous_system.asn%3A${asn}+and+ip%3A%60${result.end}%2F${subnet}%60%29+and+services.software.product%3D%60S3%60%29&virtual_hosts=${vhost}&field=${field}&num_buckets=1000`;
      } else {
        url = `https://search.censys.io/search/report?resource=hosts&q=%28services.http.response.headers%3A+%28key%3A%60Last-Modified%60+and+value.headers%3A%60${formattedDate}%60%29+and+autonomous_system.asn%3A${asn}+and+ip%3A%5B${result.start}+to+${result.end}%5D%29+and+services.software.product%3D%60S3%60&virtual_hosts=${vhost}&field=${field}&num_buckets=1000`;
      }

      document.getElementById("url").value = url;
    }

    function openURL() {
      const url = document.getElementById("url").value;
      if (openedTab) openedTab.close();
      openedTab = window.open(url, "_blank");
    }

    function incrementIPAddress() {
      const ipAddressInput = document.getElementById("ipAddress");
      const ipParts = ipAddressInput.value.split(".");
      ipParts[2] = (parseInt(ipParts[2]) + 8).toString();
      ipAddressInput.value = ipParts.join(".");
    }

    function calculateIPRangeFunction(ip, subnet) {
      const ipOctets = ip.split(".").map(Number);
      const mask = ~(2 ** (32 - subnet) - 1);
      const ipInt = (ipOctets[0] << 24) | (ipOctets[1] << 16) | (ipOctets[2] << 8) | ipOctets[3];
      const networkInt = ipInt & mask;
      const broadcastInt = networkInt | ~mask;

      const start = [
        (networkInt >>> 24) & 255,
        (networkInt >>> 16) & 255,
        (networkInt >>> 8) & 255,
        networkInt & 255,
      ].join(".");
      const end = [
        (broadcastInt >>> 24) & 255,
        (broadcastInt >>> 16) & 255,
        (broadcastInt >>> 8) & 255,
        broadcastInt & 255,
      ].join(".");
      return { start, end };
    }

    function saveToHistory(key, value) {
      if (!value || !/^\d{1,3}(\.\d{1,3}){3}$/.test(value)) return;

      let history = JSON.parse(localStorage.getItem(key)) || [];
      if (!history.includes(value)) {
        history.unshift(value);
        if (history.length > 150) history.pop();
        localStorage.setItem(key, JSON.stringify(history));
        populateHistoryList(key);
      }
    }

    function populateHistoryList(key) {
      const idMap = {
        ipHistory: "ipHistoryList",
        manualStartHistory: "manualStartList",
        manualEndHistory: "manualEndList",
      };
      const list = document.getElementById(idMap[key]);
      if (!list) return;
      list.innerHTML = "";
      const history = JSON.parse(localStorage.getItem(key)) || [];
      history.forEach(ip => {
        const option = document.createElement("option");
        option.value = ip;
        list.appendChild(option);
      });
    }

    window.onload = function () {
      ["ipHistory", "manualStartHistory", "manualEndHistory"].forEach(populateHistoryList);
    };
  </script>
</body>
</html>
